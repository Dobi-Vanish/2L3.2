<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>URL Shortener</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
  <h1 class="text-center mb-4">URL Shortener</h1>
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Создать короткую ссылку</h5>
          <form id="shortenForm">
            <div class="mb-3">
              <label for="url" class="form-label">Оригинальный URL</label>
              <input type="url" class="form-control" id="url" required>
            </div>
            <div class="mb-3">
              <label for="alias" class="form-label">Кастомный алиас (необязательно)</label>
              <input type="text" class="form-control" id="alias" pattern="[a-zA-Z0-9]+" maxlength="20">
              <div class="form-text">Только буквы и цифры, максимум 20 символов</div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Создать</button>
          </form>
          <div id="result" class="mt-3" style="display: none;">
            <div class="alert alert-success">
              Короткая ссылка: <a href="#" id="shortLink" target="_blank"></a>
            </div>
          </div>
          <div id="error" class="mt-3" style="display: none;">
            <div class="alert alert-danger"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row justify-content-center mt-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Аналитика по ссылке</h5>
          <form id="analyticsForm">
            <div class="mb-3">
              <label for="shortCode" class="form-label">Короткий код ссылки</label>
              <input type="text" class="form-control" id="shortCode" placeholder="например: abc123" required>
            </div>
            <button type="submit" class="btn btn-secondary w-100">Получить аналитику</button>
          </form>
          <div id="analyticsResult" class="mt-3" style="display: none;">
            <h6>Статистика:</h6>
            <p>Всего переходов: <span id="totalClicks"></span></p>
            <h6>Последние переходы:</h6>
            <ul id="recentClicks" class="list-group"></ul>
          </div>
          <div id="analyticsError" class="mt-3" style="display: none;">
            <div class="alert alert-danger"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  document.getElementById('shortenForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const url = document.getElementById('url').value;
    const alias = document.getElementById('alias').value;
    const resultDiv = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    const shortLink = document.getElementById('shortLink');

    try {
      const response = await fetch('/api/shorten', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, custom_alias: alias || undefined })
      });
      const data = await response.json();
      if (!response.ok) {
        errorDiv.querySelector('.alert-danger').textContent = data.message || 'Ошибка';
        errorDiv.style.display = 'block';
        resultDiv.style.display = 'none';
      } else {
        shortLink.href = data.short_url;
        shortLink.textContent = data.short_url;
        resultDiv.style.display = 'block';
        errorDiv.style.display = 'none';
        document.getElementById('shortenForm').reset();
      }
    } catch (err) {
      errorDiv.querySelector('.alert-danger').textContent = 'Ошибка сети';
      errorDiv.style.display = 'block';
      resultDiv.style.display = 'none';
    }
  });

  document.getElementById('analyticsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const shortCode = document.getElementById('shortCode').value.trim();
    const resultDiv = document.getElementById('analyticsResult');
    const errorDiv = document.getElementById('analyticsError');

    try {
      const response = await fetch(`/api/analytics/${shortCode}`);
      const data = await response.json();
      if (!response.ok) {
        errorDiv.querySelector('.alert-danger').textContent = data.message || 'Ошибка';
        errorDiv.style.display = 'block';
        resultDiv.style.display = 'none';
      } else {
        document.getElementById('totalClicks').textContent = data.total_clicks;
        const list = document.getElementById('recentClicks');
        list.innerHTML = '';
        data.recent_clicks.forEach(item => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = `${new Date(item.timestamp).toLocaleString()} - UA: ${item.user_agent || 'unknown'}`;
          list.appendChild(li);
        });
        resultDiv.style.display = 'block';
        errorDiv.style.display = 'none';
      }
    } catch (err) {
      errorDiv.querySelector('.alert-danger').textContent = 'Ошибка сети';
      errorDiv.style.display = 'block';
      resultDiv.style.display = 'none';
    }
  });
</script>
</body>
</html></title>
</head>
<body>

</body>
</html>